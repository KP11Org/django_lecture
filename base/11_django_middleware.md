**Лекция: Middleware Django**

---

**1. Введение в Middleware Django**  
- **Определение**: лёгкие, многократно используемые компоненты, которые глобально обрабатывают запросы/ответы.  
- **Назначение**: перехватывать и изменять HTTP-запросы/ответы на уровне фреймворка (например, аутентификация, ведение журнала, безопасность).  
- **Роль в цикле запроса-ответа**:  
  - **Запрос**: обрабатывается сверху вниз через middleware до того, как он достигнет представления.  
  - **Ответ**: обрабатывается снизу вверх через middleware после выхода из представления.  
- **Основные варианты использования**: обработка сеанса, защита от CSRF, аутентификация, ведение журнала, кэширование.  

---

**2. Структура промежуточного ПО**  
- **На основе классов**: в современном Django используется промежуточное ПО на основе классов с такими хуками, как:  
  ```python
  class SimpleMiddleware:
      def __init__(self, get_response):
          self.get_response = get_response  # Одноразовая настройка.
  
      def __call__(self, request):
          # Код, выполняемый ДО представления (на этапе запроса).
          response = self.get_response(request)
          # Код, выполняемый ПОСЛЕ представления (на этапе ответа).
          return response
  
      # Дополнительные методы:
      def process_view(self, request, view_func, view_args, view_kwargs):
          # Выполняется до вызова функции представления.
          return None  # Or HttpResponse to short-circuit.
  
      def process_exception(self, request, exception):
          # Обрабатывает исключения, возникающие в представлениях.
          return None
  
      def process_template_response(self, request, response):
          # Обрабатывает ответы шаблонов.
          return response
  ```
- **На основе функций (устаревший)**: более старый подход с использованием функций (менее распространенный в современном Django).  

---

**3. Порядок промежуточного программного обеспечения**  
- **Порядок имеет значение**: определяется в `settings.MIDDLEWARE`; выполняется сверху вниз для запросов и снизу вверх для ответов.  
- **Пример порядка**:  
  ```python
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',  # Выполняется первым при запросах.
      'django.contrib.sessions.middleware.SessionMiddleware',
      'django.middleware.common.CommonMiddleware',
      'django.middleware.csrf.CsrfViewMiddleware',  # Выполняется последним при запросах.
      # ...
  ]
  ```
- **Критический порядок выполнения**: Middleware безопасности в первую очередь, Middleware сеанса/аутентификации — во вторую.  

---

**4. Встроенное промежуточное ПО**  
- **Общее промежуточное ПО**:  
  - `SecurityMiddleware`: обеспечивает работу HTTPS, заголовков безопасности.  
  - `SessionMiddleware`: управляет данными сеанса.  
  - `AuthenticationMiddleware`: прикрепляет `request.user`.  
  - `CsrfViewMiddleware`: проверяет токены CSRF.  
  - `MessageMiddleware`: обрабатывает пользовательские сообщения.  

---

**5. Создание пользовательского промежуточного программного обеспечения (Middleware)**  
- **Шаг 1**: Определите класс промежуточного программного обеспечения (например, `LoggingMiddleware`):  
  ```python
  import time

  class LoggingMiddleware:
      def __init__(self, get_response):
          self.get_response = get_response
  
      def __call__(self, request):
          start_time = time.time()
          response = self.get_response(request)
          duration = time.time() - start_time
          print(f"Запрос на {request.path} занял {duration:.2f} секунд.")
          return response
  ```
- **Шаг 2**: Добавьте в `settings.MIDDLEWARE`:  
  ```python
  MIDDLEWARE = [
      # ...
      'myapp.middleware.LoggingMiddleware',
  ]
  ```

---

**6. Рекомендации**  
- **Делайте его простым**: избегайте сложных вычислений (влияет на все запросы).  
- **Внимательно выбирайте порядок**: убедитесь, что соблюдаются зависимости (например, сеанс перед аутентификацией).  
- **Тщательно тестируйте**: Middleware влияет на все запросы; тестируйте крайние случаи.  
- **Сначала используйте встроенные функции**: используйте Middleware Django, прежде чем писать собственную логику.  

---

**7. Распространенные сценарии использования**  
- **Ведение журнала**: отслеживайте показатели запросов/ответов (например, продолжительность, IP).  
- **Аутентификация**: прикрепляйте пользовательские данные к запросам.  
- **Изменение заголовков**: добавляйте заголовки CORS или пользовательские заголовки безопасности.  
- **Ограничение скорости**: ограничение доступа к API по IP/пользователю.  
- **Флаги функций**: включение/отключение функций на основе запроса.  

---

**8. Потенциальные проблемы**  
- **Бесконечные циклы**: Middleware, рекурсивно изменяющее запросы/ответы.  
- **Перегрузка производительности**: избыточное Middleware замедляет все запросы.  
- **Зависимость от порядка**: неправильный порядок нарушает функциональность (например, CSRF до аутентификации).  

---

**9. Пример: блокировка нежелательных пользовательских агентов**  
```python
class BlockUserAgentMiddleware:
    BAD_USER_AGENTS = ['curl', 'wget']

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        user_agent = request.META.get('HTTP_USER_AGENT', '').lower()
        for agent in self.BAD_USER_AGENTS:
            if agent in user_agent:
                return HttpResponse("Access denied!", status=403)
        return self.get_response(request)
```

---

**10. Заключение**  
- **Основные выводы**: Middleware — это мощный инструмент для решения сквозных задач. Уделяйте приоритетное внимание порядку, эффективности и тестированию.  
- **Дальнейшие шаги**: изучите расширенные шаблоны (например, цепочку промежуточного программного обеспечения), асинхронное промежуточное программное обеспечение (Django 3.1+) или сторонние пакеты, такие как `django-cors-headers`.  

**Дополнительные ресурсы**:  
- [Документация Django по промежуточному программному обеспечению](https://docs.djangoproject.com/en/4.0/topics/http/middleware/)  
- Книга: *Django для API* Уильяма С. Винсента 

---

### Домашнее задание: middleware Django

#### Цель:
 Цель этого задания — помочь вам понять и попрактиковаться в работе с промежуточным ПО Django. Вы узнаете, как создавать пользовательское middleware, изменять запросы и ответы, а также обрабатывать исключения с помощью middleware.

---


### Часть 1: Создание пользовательского промежуточного ПО 

1. **Создайте простое промежуточное ПО**
   - Создайте пользовательский класс middleware под названием `SimpleLoggingMiddleware`.
   - Реализуйте методы `__init__` и `__call__`.
   - Выводите путь запроса (`request.path`) на консоль при каждой обработке запроса.
   - Добавьте свое промежуточное ПО в список `MIDDLEWARE` в `settings.py`.

2. **Измените ответ**
   - Создайте собственный класс middleware с именем `CustomHeaderMiddleware`.
   - Добавьте собственный заголовок (`X-Custom-Header: Привет, промежуточное ПО!`) в каждый ответ.
   - Протестируйте своё middleware, проверив заголовки ответа в инструментах разработчика браузера.

3. **Обработка исключений**
   - Создайте собственный класс middleware с именем `CustomErrorMiddleware`.
   - Реализуйте метод `process_exception` для регистрации любых исключений, возникающих во время обработки запроса.
   - Протестируйте своё middleware, вызвав исключение в одном из ваших представлений.

---

### Часть 2: Расширенное промежуточное программное обеспечение (30 баллов)

1. **Промежуточное программное обеспечение для фильтрации IP-адресов** 
   - Создайте собственный класс middleware с именем `IPFilterMiddleware`.
   - Блокируйте запросы с определённого IP-адреса (например, `127.0.0.1`), возвращая ответ `403 Запрещено`.
   - Выводите заблокированный IP-адрес в консоль.

---

### Часть 3: Бонус 

1. **Промежуточное ПО для ограничения скорости**
   - Создайте собственный класс middleware с именем `RateLimitingMiddleware`.
   - Ограничьте количество запросов с одного IP-адреса до 10 запросов в минуту.
   - Возвращайте ответ `429 «Слишком много запросов»`, если лимит превышен.

2. **Промежуточное программное обеспечение для изменения контента** 
   - Создайте собственный класс middleware с именем `ContentModificationMiddleware`.
   - Измените содержимое ответа, заменив все вхождения слова «Django» на «Python Django».
   - Протестируйте middleware, проверив содержимое ответа в браузере.

---

### **Рекомендации по отправке**  
- Отправьте репозиторий на GitHub с:  
  - Проектом на Django, в котором реализованы все части домашней работы.  
  - `README.md`, Скриншоты middleware в действии.  
